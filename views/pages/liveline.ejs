<!DOCTYPE html>
<html>
<head>
  <% include ../partials/header.ejs %>

<style>
	li.motto {
	    border: 1px solid black;
	    margin: 0px;
	    padding: 10px;
	}
</style>

</head>

<body>

<% include ../partials/nav.ejs %>

<div class="container">

<h2> Lifeline </h2>



<% if (alivemottos.length > 0 ){ %>
    <% alivemottos.forEach(function(r) { %>

	<div class="row">
	 <div class="col s12 m8">
	  <div class="card hoverable small sticky-action ">

	    <div class="card-content">
	      <span class="card-title activator grey-text text-darken-4"><i class="material-icons right">more_vert</i></span>
	      <p ><%- r.extract %></p>
	    </div>
	    <div class="card-reveal">
		<span class="card-title activator grey-text text-darken-3"><a href="/liveline/<%= r.hash %>/"> <%- r.hash %> </a> <i class="material-icons right">close</i></span>
		<%- r.extract %>
	    </div>
	    <div class="card-action">

		<span class = "lifespan" data-motto-did = "<%= r.did %>" value="<%= r.shill %>" style="position: relative; bottom: 0px; float: right"> </span> 
	      
		<a class="btn-floating btn-large waves-effect waves-light voting" id="+<%= r.did %>"><i class="material-icons">add_box</i></a>
		<a class="btn-floating btn-large waves-effect waves-light voting" id="0<%= r.did %>"><i class="material-icons">panorama_fish_eye</i></a>
		<a class="btn-floating btn-large waves-effect waves-light voting" id="-<%= r.did %>"><i class="material-icons">indeterminate_check_box</i></a>

	     
        
	    </div>
	  </div>
	 </div>
	</div>


    <% }); %>   
<% }else{ %>

    <%- "<p>No motto alive!</p>" %> 
<% } %> 


<% if (typeof mottoArea !== 'undefined' ) { %>
	<%- mottoArea %>
<% }else{ %>
	<%- "<p>Failed to include mottoarea </p>" %> 
<%  } %>
</div>


<script>
	    var vbtn = document.querySelectorAll('.voting');
	    for (var i=0; i < vbtn.length; i++){	
		vbtn[i].addEventListener('click', (e)=>{

			let a_elm = e.target.tagName === "I" ? e.target.parentNode : e.target;

			sendVote(a_elm.id.toString(), (vote) => {
				let action_div = (function pdiv (p){if(p.tagName === "DIV" && p.className === "card-action"){ return p}else{ return pdiv(p.parentNode)}})(a_elm);

				if (vote) disableVoted(action_div, a_elm );
			});
		}, false);
	    }

	    var ls = document.getElementsByClassName('lifespan');
	    for (var j=0; j<ls.length; j++){

		var diff = ls[j].getAttribute("value") - (new Date()).getTime();
		var interval = diff > (24 * 3600000) ? 3600000 : (diff > 3600000 ? 60000 : 1000);
		ls[j].innerHTML = ">1 day";

		setInterval( lifetimer, interval, ls[j]);
	    }


	function disableVoted(btnprnt, btn){
		const clr = {"+": "green", "0": "grey", "-": "red"}

		//disable voting buttons after click
		btnprnt.querySelectorAll('.voting').forEach((a)=>{
			a.classList.add("disabled");
		});

		//change color of pressed button (i element)
		btn.childNodes[0].classList.add(clr[btn.id.toString().slice(0,1)]);

	}
	
	function sendVote(v, cb){

		var http = new XMLHttpRequest();
		var url = "/vote";
		var params = {"v":v.substr(0,1), 'did': v.substr(1) };
		http.open("POST", url, true);
	
		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "text/html"); 
		
		http.onreadystatechange = function() {//Call a function when the state changes.
    			if(http.readyState == 4 && http.status == 200) {

				if ( http.responseText == "OK"+v){
					cb( true);
				}else{
					alert("Couldn't record your Vote!");
					cb( false);
				}

   			}
		}
		http.send(JSON.stringify(params));
	}

	function lifetimer(m){
		var d = m.getAttribute("value") - (new Date()).getTime();
		m.parentElement.style.background= d<=60000 ? "rgba(255,0,0,0.6)" : "rgba(255,255,255,0.6)";
		var days = Math.floor(d / (1000 * 60 * 60 * 24));
		var hours = Math.floor((d % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
		var minutes = Math.floor((d % (1000 * 60 * 60)) / (1000 * 60));
		var seconds = Math.floor((d % (1000 * 60)) / 1000);

		m.innerHTML = days + "d:" + hours + "h:" + minutes + "m:" + seconds + "s";

		// If the count down is over, write some text 
		if (d < 0) {
			//clearInterval(countdown);
			m.innerHTML = "EXPIRED";
			m.parentElement.style.background= "rgba(255,0,0,1)";
		}

		if (days >=1) {
			//clearInterval(countdown);
			m.innerHTML = ">1 day";
			m.parentElement.style.background= "rgba(0,255,0,1)";
		}
	}
	</script>
<% include ../partials/scriptsInHtml.ejs %>
</body>
</html>
